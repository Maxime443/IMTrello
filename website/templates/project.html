{% extends "base.html" %} {% block title %}Project{% endblock %}
{% block share %}
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal_share">
        Share
</button>
{% endblock %}
{% block content
%}
<div display="flex">
<h1 align="center">
    {{ project.name }}
</h1>
</div>


<ul class="list-group list-group-flush" id="sections">
  {% for section in project.sections %}
  <li class="list-group-item">
    {{ section.name }}

    <button type="button" class="close" onClick="deleteSection({{ section.id }})">
      <span aria-hidden="true">&times;</span>
    </button>
        <div >
            <button type="button" class="btn btn-primary" onclick="showModalforNewTask({{ section.id }})">
        New Task
            </button>

        </div>
        <ul class="list-group list-group-flush" id="task">
          {% for task in section.tasks %}
              <li class="list-group-item">
                {{ task.name }}


                  <div >
                    <button type="button" class="btn btn-primary" onclick="showModalforOpenTask({{ task.id }})">
                         Open
                    </button>

                  </div>


              </li>
          {% endfor %}


</ul>




  </li>
  {% endfor %}


</ul>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_new_section">
        New Section
    </button>

<div class="modal fade" id="modal_new_section">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    New Section
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
            <input type="hidden" name="action" value="add_section">
            <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Section Name</label>
                            <input type="text"
                                   class="form-control"
                                   id="section_name"
                                   name="section_name"
                                   placeholder="This section's name"/>
                        </div>

            </div>
            <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" >Create Section</button>
            </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_share">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Add developers
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <input type="hidden" name="action" value="add_developer">
             <form method="POST" action="/project/{{ project.id }}">
             <input type="hidden" name="action" value= "add_developer">
	         <div class="modal-body">
             <label for="name">Share to</label>
	         <div class="form-group">
                 <select id="developer_emails"
			             name="developer_emails"
			             class="js-example-basic-multiple"
			             multiple="multiple">
			         {% for email in user_emails %}
			         <option value="{{ email }}">{{ email }}</option>
			         {% endfor %}
			     </select>
	         </div>
            </div>
            <div class="modal-footer">
	            <button type="submit" class="btn btn-primary" >Add</button>
            </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_new_task">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    New Task
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
            <input type="hidden" name="action" value="add_task">
            <input type="hidden" name="task_section_id" id="task_section_id" value="">
            <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Task Name</label>
                            <input type="text"
                                   class="form-control"
                                   id="task_name"
                                   name="task_name"
                                   placeholder="This task's name"/>
                        </div>
                        <div class="form-group">
                            <label for="description">Task Description</label>
                            <input type="text"
                                   class="form-control"
                                   id="task_description"
                                   name="task_description"
                                   placeholder="This task's description"/>
                        </div>

            </div>
            <div class="modal-footer">
                    <button action="add_task" type="submit" class="btn btn-primary" >Add Task</button>
            </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modal_open_task">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="open_task_title">

                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
           <div class="modal-body">
                <div class="content" id="open_task_description">

                </div>
                <div class="open_task_status">
                    <label for="task_status_select">Status</label>
                    <select id="task_status_select" onchange="">
                      <option value="todo">To Do</option>
                      <option value="in_progress">In Progress</option>
                      <option value="completed">Completed</option>
                    </select>
                </div>

            </div>

        </div>
    </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
  function deleteSection(sectionId) {
  fetch("/delete-section", {
    method: "POST",
    body: JSON.stringify({ sectionId: sectionId }),
  }).then((_res) => {
    window.location.href = "/project/" + {{ project.id }};
  });
  }

  function showModalforNewTask(sectionId) {
            // Set the value of the hidden input field with the project ID
            document.getElementById('task_section_id').value = sectionId;

            // Show the modal
            $('#modal_new_task').modal('show');
  }
function updateTaskStatus(task_id) {
    const new_status = document.getElementById("task_status_select").value;

    fetch('/update_task_status/' + task_id, {
    method: "POST",
       headers: {
            'Content-Type': 'application/json'
        },
    body: JSON.stringify({ status: new_status }),
  }).then(response => {
        if (!response.ok) {
            throw new Error('Failed to update task status');
        }
        console.log('Task status updated successfully.');
        //window.location.href = "/project/" + {{ project.id }};
        // You can add additional handling here if needed
    })
    .catch(error => {
        console.error('Error:', error);
    });

}

  function showModalforOpenTask(task_id) {
      fetch("/get-task-infos/" + task_id)
          .then(response => response.json())
          .then(task => {
              if (task.error) {
                  console.error(task.error);
              } else {
                  console.log(task.name)
                  console.log(task.description)
                  console.log(task.status)
                  $('#open_task_title').text(task.name); // Set the value attribute of the h5 element
                  $('#open_task_description').text(task.description);
                  console.log("hi0" +  $('#task_status_select').value)
                   $('#task_status_select').value = task.status
                  console.log("hi" + task.status)
                  console.log("ho" +  $('#task_status_select').value)
                  $('#task_status_select').val(task.status);
                  console.log("ho2" + $('#task_status_select').value)

                  $('#task_status_select').on('change', function() {
                        updateTaskStatus(task_id);
                    });
                  console.log($('#task_status_select'))

                  // Show the modal
                  $('#modal_open_task').modal('show');
              }
          })
          .catch(error => console.error(error));

  }

</script>

    <script>
    /*
        $(document).ready(function() {
            $('#emailInput').select2({
                tags: true,
                tokenSeparators: [',', ' '],
                placeholder: "Entrez les adresses e-mail"
            });
        });
*/

    </script>
{% endblock %}