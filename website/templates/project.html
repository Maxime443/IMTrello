{% extends "base.html" %} {% block title %}Project{% endblock %}
{% block share %}
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal_share">
        Share
</button>
{% endblock %}
{% block content %}
<div display="flex">
<h1 align="center">
    {{ project.name }}
</h1>
</div>


<ul class="list-group list-group-flush" id="sections">
  {% for section in project.sections %}
  <li class="list-group-item">
    {{ section.name }}

    <button type="button" class="close" onClick="deleteSection({{ section.id }})">
      <span aria-hidden="true">&times;</span>
    </button>
        <div >
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_new_task_{{ section.id }}">
        New Task
            </button>

        </div>
        <ul class="list-group list-group-flush" id="task">
          {% for task in section.tasks %}
              <li class="list-group-item">
                {{ task.name }}


                  <div >

                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_open_task_{{ task.id }}">
                         Open
                    </button>

                  </div>


                  <div class="modal fade" id="modal_open_task_{{ task.id }}">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 id="open_task_title">

                                    </h5>
                                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                               <div class="modal-body">
                                    <div class="content" id="open_task_description">

                                    </div>
                                    <div class="open_task_status">
                                        <label for="task_status_select">Status</label>
                                   {{ task.status }}
                                    {{ task.name }}
                                    {{ task.id }}
                                        <select id="task_status_select" onchange="updateTaskStatus({{ task.id }}, value)">
                                            {% if task.status == "todo" %}
                                                <option value="todo" selected>To Do</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            {% elif task.status == "in_progress" %}
                                                <option value="todo">To Do</option>
                                                <option value="in_progress" selected>In Progress</option>
                                                <option value="completed">Completed</option>
                                            {% elif task.status == "completed" %}
                                                <option value="todo">To Do</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="completed" selected>Completed</option>
                                            {% else %}
                                                <option value="todo">To Do</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            {% endif %}
                                        </select>
                                    </div>
                                   <div>
                                       <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal_share_task_{{ task.id }}">
                                                Share
                                        </button>
                                       <div>
                                           Devs on this task :
                                       </div>
                                            <div id="dev_list">
                                                <ul class="list-group"> <!-- Added ul tag to enclose list items -->
                                                    {% for user_record in user_task_records %}
                                                        {%  if task in user_record.tasks %}
                                                            <li class="list-group-item">
                                                                {{ user_record.first_name }}
                                                                <button class="btn-close" aria-label="Close" onclick="remove_dev_from_task({{ user_record.id }},{{ task.id }})"></button><!-- Displaying the name of the user associated with the task -->
                                                            </li>
                                                        {%  endif %}

                                                    {% endfor %}


                                                </ul>

                                        </div>




                                   </div>

                                </div>

                            </div>
                        </div>
                    </div>

              <div class="modal fade" id="modal_share_task_{{ task.id }}">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">
                                        Add developers
                                    </h5>
                                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>


                                 <form method="POST" action="/project/{{ project.id }}">
                                 <input type="hidden" name="action" value= "add_developer_to_task">
                                 <input type="hidden" id="task_id_{{ task.id }}" name="task_id" value={{ task.id }}>
                                 <div class="modal-body">
                                 <label for="name">Share to</label>
                                 <div class="form-group">
                                     <select id="developer_emails_for_task_{{ task.id }}"
                                             name="developer_emails_for_task"
                                             class="js-example-basic-multiple"
                                             multiple="multiple">
                                         {% for email in user_emails %}
                                         <option value="{{ email }}">{{ email }}</option>
                                         {% endfor %}
                                     </select>
                                 </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary" >Add</button>
                                </div>
                                </form>
                            </div>
                        </div>
                    </div>


              </li>

              <div class="modal fade" id="modal_share">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    Add developers
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <input type="hidden" name="action" value="add_developer">
             <form method="POST" action="/project/{{ project.id }}">
             <input type="hidden" name="action" value= "add_developer">
	         <div class="modal-body">
             <label for="name">Share to</label>
	         <div class="form-group">
                 <select id="developer_emails_{{ task.id }}"
			             name="developer_emails"
			             class="js-example-basic-multiple"
			             multiple="multiple">
			         {% for email in user_emails %}
			         <option value="{{ email }}">{{ email }}</option>
			         {% endfor %}
			     </select>
	         </div>
            </div>
            <div class="modal-footer">
	            <button type="submit" class="btn btn-primary" >Add</button>
            </div>
            </form>
        </div>
    </div>
</div>




          {% endfor %}

  </ul>




  </li>


      <div class="modal fade" id="modal_new_task_{{ section.id }}">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    New Task
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
            <input type="hidden" name="action" value="add_task">
            <input type="hidden" name="task_section_id" id="task_section_id_{{ section.id }}" value={{ section.id }}>
            <div class="modal-body">
                        <div class="form-group">
                            <label for="name">Task Name</label>
                            <input type="text"
                                   class="form-control"
                                   id="task_name_{{ section.id }}"
                                   name="task_name"
                                   placeholder="This task's name"/>
                        </div>
                        <div class="form-group">
                            <label for="description">Task Description</label>
                            <input type="text"
                                   class="form-control"
                                   id="task_description_{{ section.id }}"
                                   name="task_description"
                                   placeholder="This task's description"/>
                        </div>

            </div>
            <div class="modal-footer">
                    <button action="add_task" type="submit" class="btn btn-primary" >Add Task</button>
            </div>
            </form>
        </div>
    </div>
</div>




  {% endfor %}


</ul>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal_new_section">
        New Section
    </button>

<div class="modal fade" id="modal_new_section">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    New Section
                </h5>
                <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
            <input type="hidden" name="action" value="add_section">
            <div class="modal-body">
                 <div class="form-group">
                            <label for="name">Section Name</label>
                            <input type="text"
                                   class="form-control"
                                   id="section_name"
                                   name="section_name"
                                   placeholder="This section's name"/>
                        </div>

            </div>
            <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" >Create Section</button>
            </div>
            </form>
        </div>
    </div>
</div>







    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
  function deleteSection(sectionId) {
  fetch("/delete-section", {
    method: "POST",
    body: JSON.stringify({ sectionId: sectionId }),
  }).then((_res) => {
    window.location.href = "/project/" + {{ project.id }};
  });
  }

  function remove_dev_from_task(user_id, task_id) {
  fetch("/remove-dev", {
    method: "POST",
    body: JSON.stringify({ user_id : user_id ,task_id : task_id}),
  }).then((_res) => {
    window.location.href = "/project/" + {{ project.id }};
  });
  }


  function updateTaskStatus (task_id, value) {

      fetch ( '/update_task_status/' + task_id , {
          method : "POST" ,
          headers : {
              'Content-Type' : 'application/json'
          } ,
          body : JSON.stringify ( { status : value } ) ,
      } ).then ( response => {
          if ( ! response.ok ) {
              throw new Error ( 'Failed to update task status' );
          }
          console.log ( 'Task status updated successfully.' );
          window.location.href = "/project/" + {{ project.id }};
          // You can add additional handling here if needed
      } )
          .catch ( error => {
              console.error ( 'Error:' , error );
          } );

  }




</script>

{% endblock %}